{% extends "base.html" %}
{% load crispy_forms_tags %}
{% block head %}
{% load static %}
<link href="{% static 'tinymce/css/prism.css' %}" rel="stylesheet">
{% endblock head %}
{% block content %}
<div class="container-fluid no-gutters justify-content-center d-flex ps-0 pe-0 h-100 text-light">
    <div class="col-xxl-5 col-xl-6 col-lg-7 col-md-8 col-sm-11 col-11 d-flex flex-column align-items-left">
        <!-- Page header -->
        <h2 class="text-light text-center m-5">My Account</h2>
        <hr class="border border-light border-3 opacity-75 w-100 mt-0">
        <h3>Profile</h3>
        <form method="post" id="profile-form" class="w-100">
            {% csrf_token %}
            <div class="mb-3">
                <label for="username" class="form-label">Username</label>
                <input id="username" class="form-control-plaintext text-light border border-light ps-2" type="text" value="{{ user.username }}"
                    aria-label="disable input for username" disabled>
            </div>
            <div class="mb-3">
                {{ form|crispy }}
            </div>
        </form>
        <button type="button" class="btn btn-success mb-3" data-toggle="modal"
            data-target="#email-address-update-modal">
            Update Email address
        </button>
        <a class="btn btn-success mb-3" href="{% url 'password_change' %}">Change Password</a>
        <hr class="border border-light border-3 opacity-75 w-100">
        <h3>Bumps</h3>
        <p>Bumping a server will push it higher in the listings</p>
        <p>You have {{ bumps_left }} bumps remaining.</p>
        <p>Your bumps refill as old ones expire.</p>
        <table class="table table-striped table-dark">
            <tr>
                <th scope="col">#</th>
                <th scope="col">Server</th>
                <th scope="col">Link</th>
                <th scope="col">Expiry</th>
            </tr>
            {% for bump in bumps %}
            <tr>
                <td>{{forloop.counter}}</td>
                <td>{{bump.listing}}</td>
                <td><a href="{% url 'server_detail' bump.url %}" class="text-decoration-none">Go to listing...</a></td>
                <td>{{bump.expiry}}</td>
            </tr>
            {% endfor %}
        </table>

        <hr class="border border-light border-3 opacity-75 w-100">
        <h3>Your Listings</h3>

        {% if server_listings|length == 0 %}
        <p>User has no listings</p>
        {% endif %}

        {% for listing in server_listings %}
        <!-- Listing container got loop -->
        <div class="border border-light p-1 mb-3">
            <div class="d-flex">
                <!-- Thumbnail-->
                <div class="col-3 mb-1 position-relative overflow-hidden d-flex flex-wrap justify-content-center" style="max-width: 100%; max-height: 25vh;">
                    {% if listing.image_url %}
                    <img class="img-cover" style="height: 25vh;" src="{{ listing.image_url }}" alt="Image uploaded by for listing owner.">
                    <div class="bottom-center">{{ listing.image_status }}</div>
                    {% else %}
                    <div class="d-flex flex-column justify-content-center text-bg-secondary opacity-75" style="width: 100%; height: 25vh;">
                        <p class="mb-1 text-center" style="font-size: xx-large;"><i class="bi bi-camera"></i></p>
                        <p class="mb-1 text-center" style="font-size: x-large;">Awaiting Image</p>
                    </div>
                    {% endif %}
                </div>

                <div class="col-9 ps-1">
                    <a href="{% url 'server_detail' listing.slug %}">
                        <h5 class="text-light">{{ listing.title }}</h5>
                    </a>
                    {% if listing.status == 1 %}
                    <div class='error-message alert alert-success mt-1 mb-1 p-1' role='alert'>Status: Published</div>
                    {% else %}
                    <div class='error-message alert alert-danger mt-1 mb-1 p-1' role='alert'>Status: Unpublished</div>
                    {% endif %}
                    <p class="text-light"><span class="fw-bold">Tags:</span>
                        {% for tag in listing.tags.all %}
                        <span class="badge rounded-pill bg-info text-dark">{{ tag }}</span>
                        {% endfor %}
                    </p>
                    <p class="text-light">{{ listing.short_description|safe }}</p>
                </div>
            </div>
            <div class="p-1 bg-secondary bg-opacity-25">
                <a class="btn btn-primary" href="/server_edit/{{listing.pk}}">Edit</a>
                <button type="button" class="btn btn-danger" data-item="{{listing.pk}}" data-toggle="modal"
                    data-target="#server-listing-delete-modal">
                    Delete Listing
                </button>
            </div>
        </div>
        {% endfor %}

        {% if num_of_listings >= 3 %}
        <p>You cannot create any more listings, you have reach maximum number of listings for 1 account.</p>
        {% else %}
        <a class="btn btn-success" href="{% url 'server_create' %}">Create listing</a>
        {% endif %}
        <hr class="border border-light border-3 opacity-75 w-100">
        <h3>Delete account</h3>
        <button type="button" class="btn btn-danger mb-3" data-toggle="modal" data-target="#delete-account-modal">
            Delete Account
        </button>

        <!-- Delete Account Modal -->
        <div class="modal fade text-dark" id="delete-account-modal" tabindex="-1" role="dialog"
            aria-labelledby="Delete Account Modal" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modal-title">Delete Account Confirmation</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <form method="post">
                        {% csrf_token %}
                        <div class="modal-body">
                            <p>
                                Deleting your account is permanent and irreversible.
                                <br>
                                <br>All information linked to the account will also be deleted including any listings.
                            </p>
                            {{ form_2|crispy }}
                        </div>
                        <div class="modal-footer">
                            <button type="submit" class="btn btn-danger" name="account-delete-confirm">Confirm</button>
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Email Address Update Modal -->
        <div class="modal fade text-dark" id="email-address-update-modal" tabindex="-1" role="dialog"
            aria-labelledby="Email Address Update Modal" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modal-title">Email Address Update</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <form method="post" id="email-update-form">
                        {% csrf_token %}
                        <div class="modal-body">
                            <p>
                                Please provide your updated email address.
                                <br>
                                <br>You will be sent an email to verify your new email address before it can be used.
                                <br>
                                <br>Your previous email address will become inactive when click confirm below. This
                                means features like forgotten password will no longer work until your verify the new
                                email address.
                            </p>
                            {{ email_form|crispy }}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-danger"
                                name="email-address-update-confirm">Confirm</button>
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>


        <!-- Listing delete Modal -->
        <div class="modal fade text-dark" id="server-listing-delete-modal" tabindex="-1" role="dialog"
            aria-labelledby="Sever Listing Delete Modal" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modal-title">Delete Listing Confirmation</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <form method="post" id="server-listing-delete-form">
                        {% csrf_token %}
                        <div class="modal-body">
                            <p>
                                Deleting this listing is permanent and irreversible.
                            </p>
                            {{ form_4|crispy }}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-danger"
                                name="server-listing-delete-confirm">Confirm</button>
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

    </div>
</div>
<!-- Toast -->
<div class="position-absolute top-50 start-50 translate-middle p-3" style="z-index: 11">
    <div id="liveToast" class="toast hide" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header bg-success text-light">
            <strong class="me-auto">SAVED</strong>
            <small></small>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body bg-light">
            User have been saved to the database.
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Scripts specific for this page -->
<script src="{% static 'tinymce/js/prism.js' %}"></script>
<script src="/static/js/script_my_account.js"></script>
{% endblock %}